Let me provide you with a comprehensive guide on how to emulate the Android 16 image after building from source.

## Complete Guide: Emulating Android 16 After Building

Since you've built Android 16 with the lunch target `aosp_cf_x86_64_auto-bp2a-eng`, you'll use **Cuttlefish** as the emulator. Let me walk you through the complete process.

---

## Step 1: Verify Build Completion

First, confirm your build completed successfully:

```bash
cd ~/android-16
source build/envsetup.sh
lunch aosp_cf_x86_64_auto-bp2a-eng

# Check if required images exist
ls -lh $OUT/*.img

# You should see these key images:
# system.img
# vendor.img
# boot.img
# userdata.img
# super.img (or individual partition images)
```

---

## Step 2: Install Cuttlefish Host Packages

Cuttlefish requires host-side packages to run the virtual device:

### Method A: Install from Google's Repository (Recommended)

```bash
# Add Google's repository
sudo apt-get install -y software-properties-common
sudo add-apt-repository -y ppa:canonical-server/server-backports

# Update and install Cuttlefish
sudo apt-get update
sudo apt-get install -y \
    qemu-kvm \
    libvirt-daemon-system \
    libvirt-clients \
    bridge-utils \
    android-sdk-platform-tools-common

# Install Cuttlefish packages
cd /tmp
wget https://github.com/google/android-cuttlefish/releases/latest/download/cuttlefish-base_*_amd64.deb
wget https://github.com/google/android-cuttlefish/releases/latest/download/cuttlefish-user_*_amd64.deb

sudo dpkg -i ./cuttlefish-base_*_amd64.deb || sudo apt-get install -f
sudo dpkg -i ./cuttlefish-user_*_amd64.deb || sudo apt-get install -f
```

### Method B: Build from Source

```bash
# Clone Cuttlefish repository
cd ~
git clone https://github.com/google/android-cuttlefish
cd android-cuttlefish

# Build base package
cd base
sudo mk-build-deps -i -r
dpkg-buildpackage -uc -us
cd ..
sudo dpkg -i ./cuttlefish-base_*_amd64.deb || sudo apt-get install -f

# Build user package
cd frontend
sudo mk-build-deps -i -r
dpkg-buildpackage -uc -us
cd ..
sudo dpkg -i ./cuttlefish-user_*_amd64.deb || sudo apt-get install -f
```

### Step 3: Configure User Permissions

```bash
# Add your user to required groups
sudo usermod -aG kvm,cvdnetwork,render $USER

# Verify groups (after logging out and back in)
groups

# Should show: ... kvm cvdnetwork render ...

# If groups don't show, reboot
sudo reboot
```

After reboot, verify KVM access:

```bash
# Check KVM device
ls -l /dev/kvm
# Should show: crw-rw----+ 1 root kvm ...

# Test KVM access
kvm-ok
# Should output: INFO: /dev/kvm exists
#                KVM acceleration can be used
```

---

## Step 3: Launch Cuttlefish Emulator

### Basic Launch

```bash
cd ~/android-16
source build/envsetup.sh
lunch aosp_cf_x86_64_auto-bp2a-eng

# Launch with default settings
launch_cvd
```

**Expected Output:**
```
[INFO] Launching cuttlefish virtual device
[INFO] Kernel: 6.1.x
[INFO] Boot image: /path/to/boot.img
[INFO] System image: /path/to/system.img
...
VIRTUAL_DEVICE_BOOT_STARTED
VIRTUAL_DEVICE_BOOT_COMPLETED
Virtual device booted successfully

Access your device via:
  Web UI: https://localhost:8443
  ADB:    adb connect localhost:6520
  VNC:    localhost:6444
```

### Advanced Launch with Custom Configuration

```bash
# Launch with specific settings
launch_cvd \
    --daemon \
    --cpus=4 \
    --memory_mb=6144 \
    --gpu_mode=drm_virgl \
    --start_webrtc=true \
    --webrtc_device_id=automotive-dev-1 \
    --data_policy=always_create \
    --blank_data_image_mb=8192
```

**Parameter Explanations:**
- `--daemon`: Run in background
- `--cpus=4`: Use 4 CPU cores
- `--memory_mb=6144`: Allocate 6GB RAM (automotive needs more)
- `--gpu_mode=drm_virgl`: Enable GPU acceleration
- `--start_webrtc=true`: Enable web browser access
- `--webrtc_device_id`: Custom device identifier
- `--data_policy=always_create`: Always create fresh userdata
- `--blank_data_image_mb=8192`: 8GB userdata partition

---

## Step 4: Access the Emulator

### Option A: Web Browser Interface (Best for Automotive)

```bash
# Open in your default browser
xdg-open https://localhost:8443

# Or manually navigate to:
# https://localhost:8443
```

You'll see a full Android Automotive interface in your browser with:
- Interactive display
- Touch/mouse input
- Audio support
- Real-time updates

### Option B: ADB Connection

```bash
# Connect via ADB
adb connect localhost:6520

# Verify connection
adb devices
# Output: localhost:6520    device

# Access shell
adb shell

# Check Android version
adb shell getprop ro.build.version.release
# Output: 16

# Check build ID
adb shell getprop ro.build.id
# Output: BP2A.250605.031 (or similar)

# Verify it's automotive
adb shell getprop ro.build.characteristics
# Output: automotive
```

### Option C: VNC Viewer

```bash
# Install VNC viewer if needed
sudo apt-get install tigervnc-viewer

# Connect to VNC
vncviewer localhost:6444
```

### Option D: Console Access (Terminal)

```bash
# Access via console (for debugging)
screen ~/.cuttlefish_runtime/console
# or
minicom -D ~/.cuttlefish_runtime/console

# Detach: Ctrl+A, then D
```

---

## Step 5: Verify Automotive Features

Once connected via ADB:

```bash
# Check Car Service is running
adb shell dumpsys car_service

# List all services
adb shell service list | grep -i car

# Check VHAL (Vehicle HAL) is available
adb shell dumpsys android.hardware.automotive.vehicle.IVehicle/default

# Test VHAL - Get vehicle speed
adb shell /vendor/bin/vhal-get 0x11600207

# Test VHAL - Set HVAC temperature
adb shell /vendor/bin/vhal-set 0x11400503 -a 0x01 -f 22.5

# Check system UI is automotive
adb shell dumpsys window | grep -i systemui

# List installed automotive apps
adb shell pm list packages | grep -i car
```

---

## Step 6: Managing the Emulator

### Check Emulator Status

```bash
# Check if Cuttlefish is running
cvd status

# View logs
cvd logs

# List running instances
cvd instances
```

### Stop the Emulator

```bash
# Stop current instance
stop_cvd

# Stop and clear all data
stop_cvd --clear_instance_dirs

# Stop specific instance
stop_cvd --instance_num=1
```

### Restart the Emulator

```bash
# Stop first
stop_cvd

# Then launch again
launch_cvd
```

---

## Step 7: Install APKs on Emulator

```bash
# Install an APK
adb install MyAutomotiveApp.apk

# Install with replace (if already installed)
adb install -r MyAutomotiveApp.apk

# Install system app (requires remount)
adb root
adb remount
adb push MySystemApp.apk /system/priv-app/MySystemApp/
adb reboot
```

---

## Advanced Configuration

### Create a Custom Launch Script

Create `~/android-16/launch_automotive.sh`:

```bash
#!/bin/bash

# Android 16 Automotive Launch Script
set -e

echo "=========================================="
echo "Android 16 Automotive Emulator Launcher"
echo "=========================================="
echo ""

# Setup environment
cd ~/android-16
source build/envsetup.sh
lunch aosp_cf_x86_64_auto-bp2a-eng

# Check if images exist
if [ ! -f "$OUT/system.img" ]; then
    echo "ERROR: Build not found. Please build first with 'm -j\$(nproc)'"
    exit 1
fi

echo "Build found: $OUT"
echo ""

# Stop any existing instances
echo "Stopping existing instances..."
stop_cvd 2>/dev/null || true

# Launch with optimal settings for development
echo "Launching Android Automotive OS..."
echo ""

launch_cvd \
    --daemon \
    --cpus=4 \
    --memory_mb=6144 \
    --gpu_mode=drm_virgl \
    --start_webrtc=true \
    --webrtc_device_id=aaos-dev \
    --data_policy=always_create \
    --blank_data_image_mb=8192 \
    --guest_enforce_security=false \
    --setupwizard_mode=DISABLED

echo ""
echo "=========================================="
echo "Android Automotive OS Started!"
echo "=========================================="
echo ""
echo "Access methods:"
echo "  • Web UI: https://localhost:8443"
echo "  • ADB:    adb connect localhost:6520"
echo "  • VNC:    vncviewer localhost:6444"
echo ""
echo "Useful commands:"
echo "  • Stop:   stop_cvd"
echo "  • Status: cvd status"
echo "  • Logs:   cvd logs"
echo ""
echo "Waiting for device to boot..."

# Wait for device
adb connect localhost:6520 2>/dev/null
adb wait-for-device

echo ""
echo "✓ Device is ready!"
echo ""

# Show device info
echo "Device Information:"
adb shell getprop ro.build.fingerprint
echo ""

# Auto-open browser (optional)
# xdg-open https://localhost:8443
```

Make it executable:
```bash
chmod +x ~/android-16/launch_automotive.sh

# Run it
~/android-16/launch_automotive.sh
```

### Multiple Device Instances

Run multiple emulator instances simultaneously:

```bash
# Launch first instance
HOME=$HOME/cuttlefish1 launch_cvd \
    --instance_num=1 \
    --base_instance_num=1

# Launch second instance
HOME=$HOME/cuttlefish2 launch_cvd \
    --instance_num=2 \
    --base_instance_num=2

# Connect to specific instances
adb connect localhost:6520  # Instance 1
adb connect localhost:6521  # Instance 2
```

---

## Troubleshooting

### Issue 1: "launch_cvd: command not found"

```bash
# Ensure environment is set
cd ~/android-16
source build/envsetup.sh
lunch aosp_cf_x86_64_auto-bp2a-eng

# Verify launch_cvd is available
which launch_cvd
# Should show: /path/to/out/host/linux-x86/bin/launch_cvd

# If not found, rebuild host tools
m launch_cvd
```

### Issue 2: KVM Permission Denied

```bash
# Check KVM ownership
ls -l /dev/kvm

# Add user to kvm group (if not already)
sudo usermod -aG kvm $USER

# Reboot to apply
sudo reboot

# Verify after reboot
groups | grep kvm
```

### Issue 3: Port Already in Use

```bash
# Check what's using ports
sudo lsof -i :8443
sudo lsof -i :6520

# Stop existing Cuttlefish
stop_cvd --clear_instance_dirs

# Or use different ports
launch_cvd --webrtc_port=8444 --adb_port=6521
```

### Issue 4: Emulator Won't Boot

```bash
# Check logs
tail -f ~/.cuttlefish_runtime/cuttlefish/instances/cvd-1/logs/launcher.log

# Common causes:
# 1. Insufficient memory - increase with --memory_mb=8192
# 2. Missing images - verify with: ls $OUT/*.img
# 3. Corrupted build - rebuild with: make clean && m -j$(nproc)

# Clean start
stop_cvd --clear_instance_dirs
rm -rf ~/.cuttlefish_runtime/*
launch_cvd
```

### Issue 5: Black Screen in Web UI

```bash
# Try different GPU mode
launch_cvd --gpu_mode=guest_swiftshader

# Or disable GPU
launch_cvd --gpu_mode=none

# Check WebRTC is enabled
launch_cvd --start_webrtc=true
```

### Issue 6: ADB Connection Refused

```bash
# Check Cuttlefish is running
cvd status

# Reconnect ADB
adb disconnect
adb connect localhost:6520

# If still failing, check firewall
sudo ufw status
sudo ufw allow 6520
```

---

## Performance Optimization

### Optimal Launch Configuration for Development

```bash
launch_cvd \
    --cpus=$(nproc) \
    --memory_mb=8192 \
    --gpu_mode=drm_virgl \
    --start_webrtc=true \
    --enable_host_bluetooth=false \
    --enable_minimal_mode=false \
    --setupwizard_mode=DISABLED
```

### For Low-End Systems

```bash
launch_cvd \
    --cpus=2 \
    --memory_mb=4096 \
    --gpu_mode=none \
    --start_webrtc=false
```

Then connect via ADB only:
```bash
adb connect localhost:6520
adb shell
```

---

## Quick Reference Commands

```bash
# Launch emulator
launch_cvd

# Stop emulator
stop_cvd

# Check status
cvd status

# View logs
cvd logs

# Connect ADB
adb connect localhost:6520

# Open web UI
xdg-open https://localhost:8443

# Access shell
adb shell

# Install APK
adb install app.apk

# Reboot device
adb reboot

# Clean restart
stop_cvd --clear_instance_dirs && launch_cvd
```

---

## Summary

For **Android 16 Automotive** emulation after building:

1. **Install Cuttlefish packages** (one-time setup)
2. **Add user to kvm/cvdnetwork groups** (one-time setup)
3. **Launch**: `launch_cvd`
4. **Access**: 
   - Web: https://localhost:8443
   - ADB: `adb connect localhost:6520`
5. **Stop**: `stop_cvd`

**Recommended launch command for development:**
```bash
launch_cvd --daemon --cpus=4 --memory_mb=6144 --gpu_mode=drm_virgl --start_webrtc=true
```

Your Android 16 Automotive image should now be running and accessible for development and testing!

Would you like help with any specific aspect of emulation, debugging, or testing your automotive build?
